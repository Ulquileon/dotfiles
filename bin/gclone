#!/usr/bin/env bash
# gclone owner/repo [dest]
# Choisit automatiquement l'hôte SSH selon le dossier courant:
#  - ~/code/personal[/...] -> github.com-personal
#  - ~/code/school[/...]   -> github.com-school
# Par défaut: github.com-personal

set -euo pipefail

usage(){ echo "Usage: gclone owner/repo [dest] | gclone git@... | gclone https://..."; exit 1; }
[ $# -ge 1 ] || usage

arg="$1"; dest="${2:-}"

# Résoudre PWD pour matcher aussi via symlinks
if command -v realpath >/dev/null 2>&1; then
  PWD_RESOLVED="$(realpath -m "$PWD")"
else
  PWD_RESOLVED="$PWD"
fi

# Déterminer l'hôte (match le dossier ET ses sous-dossiers)
case "$PWD_RESOLVED" in
  "$HOME/code/personal"|"$HOME/code/personal"/*) host="github.com-personal" ;;
  "$HOME/code/school"|"$HOME/code/school"/*)     host="github.com-school" ;;
  *)                                             host="github.com-personal" ;;
esac

# Construire l'URL normalisée
build_url() {
  local in="$1"
  # Remap des URLs github.com -> alias choisi
  if [[ "$in" == git@github.com:* ]]; then
    echo "${in/git@github.com:/git@${host}:}"
  elif [[ "$in" == ssh://git@github.com/* ]]; then
    echo "${in/ssh:\/\/git@github.com\//git@${host}:}"
  # Autres URLs complètes: garder tel quel (git@autrehost:..., https://...)
  elif [[ "$in" =~ ^(git@|https?://) ]]; then
    echo "$in"
  else
    # owner/repo or owner/repo.git
    [[ "$in" == *.git ]] || in="${in}.git"
    echo "git@${host}:${in}"
  fi
}

url="$(build_url "$arg")"

echo "→ Clonage via ${host}: ${url}"
if [[ -n "$dest" ]]; then
  git clone "$url" "$dest"
else
  git clone "$url"
fi
